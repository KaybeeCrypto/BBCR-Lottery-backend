<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>COMMIT — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0b0f14;
      color: #e6e6e6;
      margin: 0;
      padding: 40px;
    }

    h1, h2 { font-weight: 600; }

    .box {
      max-width: 720px;
      margin: 0 auto 40px;
      padding: 24px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #11161d;
    }

    label {
      display: block;
      margin-top: 16px;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      background: #0b0f14;
      border: 1px solid #333;
      color: #e6e6e6;
      border-radius: 4px;
    }

    .time-inputs input {
      width: 80px;
      display: inline-block;
      margin-right: 8px;
    }

    button {
      margin-top: 16px;
      padding: 10px 16px;
      background: #2b6cb0;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    pre {
      background: #0b0f14;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
    }

    .status {
      margin-top: 12px;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .status.success {
      color: #4ade80;
      font-weight: 500;
    }

    .countdown-big {
      font-size: 1.4rem;
      font-weight: 600;
      margin-top: 8px;
    }

    .countdown-muted {
      font-size: 0.95rem;
      opacity: 0.7;
      margin-top: 6px;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-left: 8px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

<h1>COMMIT — Admin Panel</h1>

<div class="box">
  <h2>Admin Access</h2>
  <label>Admin Secret</label>
  <input id="secretInput" type="password" placeholder="Paste ADMIN_SECRET here" />
  <button onclick="saveSecret()">Authenticate</button>
  <div class="status" id="loginStatus">Not authenticated</div>
</div>

<div id="adminContent" style="display:none;">

  <div class="box">
    <h2>Current Admin State</h2>
    <button onclick="loadState()">Reload State</button>
    <pre id="stateOutput">—</pre>
  </div>

  <div class="box">
    <h2>Token Config</h2>
    <label>Mint Address</label>
    <input id="mintInput" />
    <label>Minimum Hold Amount</label>
    <input id="minHoldInput" type="number" />
    <button id="btnSaveToken" onclick="saveToken()">Save Token Config</button>
    <div class="status" id="tokenStatus">—</div>
  </div>

  <div class="box">
    <h2>Reset Round</h2>
    <button id="btnResetRound" onclick="resetRound()">Reset Round</button>
    <pre id="resetOutput">—</pre>
  </div>

  <div class="box">
    <h2>Snapshot Preview</h2>
    <button id="btnPreview" onclick="previewHolders()">Preview Holders</button>
    <pre id="previewOutput">—</pre>
  </div>

  <div class="box">
    <h2>Take Snapshot</h2>
    <button id="btnSnapshot" onclick="takeSnapshot()">Take Snapshot</button>
    <pre id="snapshotOutput">—</pre>
  </div>

  <div class="box">
    <h2>Commit Phase</h2>
    <div class="time-inputs">
      <input id="commitH" type="number" min="0" value="0" /> h
      <input id="commitM" type="number" min="0" max="59" value="5" /> m
      <input id="commitS" type="number" min="0" max="59" value="0" /> s
    </div>
    <button id="btnCommit" onclick="startCommit()">Start Commit</button>
    <pre id="commitOutput">—</pre>
    <div class="countdown-big" id="commitCountdown">—</div>
    <div class="status" id="commitDeadlineUtc"></div>
  </div>

  <div class="box">
    <h2>Reveal Phase <span style="opacity:.6">(admin buffer)</span></h2>
    <div class="time-inputs">
      <input id="revealH" type="number" min="0" value="0" /> h
      <input id="revealM" type="number" min="0" max="59" value="5" /> m
      <input id="revealS" type="number" min="0" max="59" value="0" /> s
    </div>
    <button id="btnReveal" onclick="startReveal()">Start Reveal</button>
    <pre id="revealOutput">—</pre>
    <div class="countdown-muted" id="revealCountdown">—</div>
    <div class="status" id="revealDeadlineUtc"></div>
  </div>

  <div class="box">
    <h2>Finalize Winner</h2>
    <button id="btnFinalize" onclick="finalizeWinner()">Finalize</button>
    <pre id="finalizeOutput">—</pre>
  </div>

</div>

<script>
const API_BASE = "https://bbcr-lottery.onrender.com";
let lastKnownState = null;
let countdownInterval = null;

function startLoading(id) {
  const b = document.getElementById(id);
  b.disabled = true;
  if (!b.querySelector(".spinner")) {
    const s = document.createElement("span");
    s.className = "spinner";
    b.appendChild(s);
  }
}

function stopLoading(id) {
  const b = document.getElementById(id);
  const s = b.querySelector(".spinner");
  if (s) s.remove();
  b.disabled = false;
}

function setButtonDisabled(id, d) {
  const el = document.getElementById(id);
  if (el) el.disabled = d;
}

function updateButtonsFromState() {
  setButtonDisabled("btnSnapshot", lastKnownState !== "IDLE");
  setButtonDisabled("btnCommit", lastKnownState !== "SNAPSHOT_TAKEN");
  setButtonDisabled("btnReveal", lastKnownState !== "COMMIT");
  setButtonDisabled("btnFinalize", lastKnownState !== "REVEAL");
}

function getSecret() {
  return localStorage.getItem("ADMIN_SECRET");
}

async function adminFetch(path, options = {}) {
  const secret = getSecret();
  if (!secret) throw new Error("Not authenticated");

  const headers = {
    "X-Admin-Secret": secret,
    ...(options.headers || {})
  };

  if (options.body && !headers["Content-Type"]) {
    headers["Content-Type"] = "application/json";
  }

  return fetch(API_BASE + path, { ...options, headers });
}

function clearCountdown() {
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
}

function startCountdown(deadlineISO, outputId, utcLabelId) {
  clearCountdown();
  const output = document.getElementById(outputId);
  const utcLabel = document.getElementById(utcLabelId);

  const deadline = Date.parse(deadlineISO);
  if (isNaN(deadline)) {
    output.textContent = "⏳ invalid deadline";
    return;
  }

  function tick() {
    const diff = deadline - Date.now();
    if (diff <= 0) {
      output.textContent = "⏳ 00:00";
      clearCountdown();
      return;
    }
    const m = Math.floor(diff / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    output.textContent = `⏳ ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  tick();
  countdownInterval = setInterval(tick, 1000);
}

function getSeconds(h, m, s) {
  return Number(h.value||0)*3600 + Number(m.value||0)*60 + Number(s.value||0);
}

async function saveSecret() {
  const v = secretInput.value.trim();
  if (!v) return;

  try {
    const r = await fetch(API_BASE + "/api/admin/state", {
      headers: { "X-Admin-Secret": v }
    });
    if (!r.ok) throw new Error();

    localStorage.setItem("ADMIN_SECRET", v);
    loginStatus.textContent = "Authenticated";
    adminContent.style.display = "block";
    await loadState();
  } catch {
    loginStatus.textContent = "Authentication failed";
  }
}

async function loadState() {
  const r = await adminFetch("/api/admin/state");
  const data = await r.json();

  stateOutput.textContent = JSON.stringify(data, null, 2);
  lastKnownState = data.round.state;
  updateButtonsFromState();

  clearCountdown();

  if (data.round.state === "COMMIT" && data.round.commit_deadline) {
    startCountdown(
      data.round.commit_deadline,
      "commitCountdown",
      "commitDeadlineUtc"
    );
    commitDeadlineUtc.textContent = `Deadline: ${data.round.commit_deadline_utc}`;
  } else {
    commitCountdown.textContent = "—";
    commitDeadlineUtc.textContent = "";
  }

  if (data.round.state === "REVEAL" && data.round.reveal_deadline) {
    startCountdown(
      data.round.reveal_deadline,
      "revealCountdown",
      "revealDeadlineUtc"
    );
    revealDeadlineUtc.textContent = `Deadline: ${data.round.reveal_deadline_utc}`;
  } else {
    revealCountdown.textContent = "—";
    revealDeadlineUtc.textContent = "";
  }
}

async function startCommit() {
  const seconds = getSeconds(commitH, commitM, commitS);
  if (seconds < 10) return alert("Commit duration must be at least 10 seconds");

  startLoading("btnCommit");
  try {
    const r = await adminFetch(
      `/api/admin/commit/start?commit_seconds=${seconds}`,
      { method: "POST" }
    );
    commitOutput.textContent = JSON.stringify(await r.json(), null, 2);
    await loadState();
  } finally { stopLoading("btnCommit"); }
}

async function startReveal() {
  const seconds = getSeconds(revealH, revealM, revealS);
  if (seconds < 10) return alert("Reveal duration must be at least 10 seconds");

  startLoading("btnReveal");
  try {
    const r = await adminFetch(
      `/api/admin/reveal/start?reveal_seconds=${seconds}`,
      { method: "POST" }
    );
    revealOutput.textContent = JSON.stringify(await r.json(), null, 2);
    await loadState();
  } finally { stopLoading("btnReveal"); }
}

async function finalizeWinner() {
  startLoading("btnFinalize");
  try {
    const r = await adminFetch("/api/admin/finalize", { method: "POST" });
    finalizeOutput.textContent = JSON.stringify(await r.json(), null, 2);
    await loadState();
  } finally { stopLoading("btnFinalize"); }
}

async function previewHolders() {
  startLoading("btnPreview");
  try {
    const r = await adminFetch("/api/admin/holders/preview", { method: "POST" });
    previewOutput.textContent = JSON.stringify(await r.json(), null, 2);
    await loadState();
  } finally { stopLoading("btnPreview"); }
}

async function takeSnapshot() {
  startLoading("btnSnapshot");
  try {
    const r = await adminFetch("/api/admin/snapshot", { method: "POST" });
    snapshotOutput.textContent = JSON.stringify(await r.json(), null, 2);
    await loadState();
  } finally { stopLoading("btnSnapshot"); }
}

async function resetRound() {
  startLoading("btnResetRound");
  try {
    const r = await adminFetch("/api/admin/round/reset", { method: "POST" });
    resetOutput.textContent = JSON.stringify(await r.json(), null, 2);
    await loadState();
  } finally { stopLoading("btnResetRound"); }
}
</script>

</body>
</html>
