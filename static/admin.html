<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>COMMIT — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0b0f14;
      color: #e6e6e6;
      margin: 0;
      padding: 40px;
    }

    h1, h2 {
      font-weight: 600;
    }

    .box {
      max-width: 720px;
      margin: 0 auto 40px;
      padding: 24px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #11161d;
    }

    label {
      display: block;
      margin-top: 16px;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      background: #0b0f14;
      border: 1px solid #333;
      color: #e6e6e6;
      border-radius: 4px;
    }

    button {
      margin-top: 16px;
      padding: 10px 16px;
      background: #2b6cb0;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    pre {
      background: #0b0f14;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
    }

    .status {
      margin-top: 12px;
      font-size: 0.9rem;
      opacity: 0.8;
    }
  </style>
</head>

<body>

<h1>COMMIT — Admin Panel</h1>

<!-- LOGIN -->
<div class="box">
  <h2>Admin Access</h2>

  <label>Admin Secret</label>
  <input id="secretInput" type="password" placeholder="Paste ADMIN_SECRET here" />

  <button onclick="saveSecret()">Authenticate</button>

  <div class="status" id="loginStatus">Not authenticated</div>
</div>

<!-- ADMIN CONTENT (HIDDEN UNTIL AUTHENTICATED) -->
<div id="adminContent" style="display:none;">

  <!-- STATE -->
  <div class="box">
    <h2>Current Admin State</h2>
    <button onclick="loadState()">Reload State</button>

    <pre id="stateOutput">—</pre>
  </div>

  <!-- TOKEN CONFIG -->
  <div class="box">
    <h2>Token Config</h2>

    <label>Mint Address</label>
    <input id="mintInput" placeholder="Token mint address" />

    <label>Minimum Hold Amount</label>
    <input id="minHoldInput" type="number" />

    <button onclick="saveToken()">Save Token Config</button>

    <div class="status" id="tokenStatus">—</div>
  </div>

  <!-- SNAPSHOT PREVIEW -->
  <div class="box">
    <h2>Snapshot Preview</h2>

    <button onclick="previewHolders()">Preview Holders</button>

    <pre id="previewOutput">—</pre>
  </div>

  <!-- TAKE SNAPSHOT -->
  <div class="box">
    <h2>Take Snapshot</h2>

    <button id="btnSnapshot" onclick="takeSnapshot()">Take Snapshot</button>

    <pre id="snapshotOutput">—</pre>
  </div>

  <!-- COMMIT PHASE -->
  <div class="box">
    <h2>Commit Phase</h2>

    <label>Commit Minutes</label>
    <input id="commitMinutesInput" type="number" value="5" min="1" />

    <button id="btnCommit" onclick="startCommit()">Start Commit</button>

    <pre id="commitOutput">—</pre>
  </div>

  <!-- REVEAL PHASE -->
  <div class="box">
    <h2>Reveal Phase</h2>

    <label>Reveal Minutes</label>
    <input id="revealMinutesInput" type="number" value="5" min="1" />

    <button id="btnReveal" onclick="startReveal()">Start Reveal</button>

    <pre id="revealOutput">—</pre>
  </div>

  <!-- FINALIZE -->
  <div class="box">
    <h2>Finalize Winner</h2>

    <button id="btnFinalize" onclick="finalizeWinner()">Finalize</button>

    <pre id="finalizeOutput">—</pre>
  </div>

</div>

<script>
const API_BASE = "https://bbcr-lottery.onrender.com";

let lastKnownState = null;

function getSecret() {
  return localStorage.getItem("ADMIN_SECRET");
}

function setButtonDisabled(id, disabled) {
  const el = document.getElementById(id);
  if (el) el.disabled = !!disabled;
}

function updateButtonsFromState() {
  // If state not loaded yet, disable everything
  if (!lastKnownState) {
    setButtonDisabled("btnSnapshot", true);
    setButtonDisabled("btnCommit", true);
    setButtonDisabled("btnReveal", true);
    setButtonDisabled("btnFinalize", true);
    return;
  }

  setButtonDisabled("btnSnapshot", lastKnownState !== "IDLE");
  setButtonDisabled("btnCommit", lastKnownState !== "SNAPSHOT_TAKEN");
  setButtonDisabled("btnReveal", lastKnownState !== "COMMIT");
  setButtonDisabled("btnFinalize", lastKnownState !== "REVEAL");
}

async function saveSecret() {
  const val = document.getElementById("secretInput").value.trim();
  if (!val) return;

  try {
    const res = await fetch(API_BASE + "/api/admin/state", {
      headers: {
        "X-Admin-Secret": val
      }
    });

    if (!res.ok) throw new Error();

    localStorage.setItem("ADMIN_SECRET", val);
    document.getElementById("loginStatus").textContent = "Authenticated";
    document.getElementById("adminContent").style.display = "block";

    document.getElementById("previewOutput").textContent = "—";

    await loadState();
    updateButtonsFromState();

  } catch {
    document.getElementById("loginStatus").textContent = "Authentication failed";
    localStorage.removeItem("ADMIN_SECRET");
  }
}

async function adminFetch(path, options = {}) {
  const secret = getSecret();
  if (!secret) throw new Error("No admin secret");

  return fetch(API_BASE + path, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      "X-Admin-Secret": secret,
      ...(options.headers || {})
    }
  });
}

async function loadState() {
  try {
    const res = await adminFetch("/api/admin/state");
    if (!res.ok) throw new Error();

    const data = await res.json();
    document.getElementById("stateOutput").textContent =
      JSON.stringify(data, null, 2);

    // IMPORTANT: update state so buttons can be enabled/disabled
    lastKnownState = data.round && data.round.state ? data.round.state : null;
    updateButtonsFromState();

    if (data.token) {
      document.getElementById("mintInput").value =
        data.token.mint_address || "";
      document.getElementById("minHoldInput").value =
        data.token.min_hold_amount || "";
    }

  } catch {
    document.getElementById("stateOutput").textContent =
      "Failed to load admin state";
    lastKnownState = null;
    updateButtonsFromState();
  }
}

async function saveToken() {
  const mint = document.getElementById("mintInput").value.trim();
  const minHold = parseInt(document.getElementById("minHoldInput").value, 10);

  if (!mint || isNaN(minHold)) {
    document.getElementById("tokenStatus").textContent = "Invalid input";
    return;
  }

  try {
    const res = await adminFetch("/api/admin/token", {
      method: "POST",
      body: JSON.stringify({
        mint_address: mint,
        min_hold_amount: minHold
      })
    });

    if (!res.ok) throw new Error();

    document.getElementById("tokenStatus").textContent = "Token config saved";
    document.getElementById("previewOutput").textContent = "—";
    await loadState();

  } catch {
    document.getElementById("tokenStatus").textContent =
      "Error saving token config";
  }
}

async function previewHolders() {
  try {
    const res = await adminFetch("/api/admin/holders/preview", {
      method: "POST"
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Preview failed");

    document.getElementById("previewOutput").textContent =
      JSON.stringify(data, null, 2);

  } catch (err) {
    document.getElementById("previewOutput").textContent =
      err.message || "Failed to preview holders";
  }
}

async function takeSnapshot() {
  try {
    const res = await adminFetch("/api/admin/snapshot", { method: "POST" });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Snapshot failed");

    document.getElementById("snapshotOutput").textContent =
      JSON.stringify(data, null, 2);

    await loadState();
  } catch (err) {
    document.getElementById("snapshotOutput").textContent =
      err.message || "Snapshot failed";
  }
}

async function startCommit() {
  const minutes = parseInt(document.getElementById("commitMinutesInput").value, 10);
  if (isNaN(minutes) || minutes < 1) {
    document.getElementById("commitOutput").textContent = "Invalid commit minutes";
    return;
  }

  try {
    const res = await adminFetch(`/api/admin/commit/start?commit_minutes=${minutes}`, {
      method: "POST"
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Commit start failed");

    document.getElementById("commitOutput").textContent =
      JSON.stringify(data, null, 2);

    await loadState();
  } catch (err) {
    document.getElementById("commitOutput").textContent =
      err.message || "Commit start failed";
  }
}

async function startReveal() {
  const minutes = parseInt(document.getElementById("revealMinutesInput").value, 10);
  if (isNaN(minutes) || minutes < 1) {
    document.getElementById("revealOutput").textContent = "Invalid reveal minutes";
    return;
  }

  try {
    const res = await adminFetch(`/api/admin/reveal/start?reveal_minutes=${minutes}`, {
      method: "POST"
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Reveal start failed");

    document.getElementById("revealOutput").textContent =
      JSON.stringify(data, null, 2);

    await loadState();
  } catch (err) {
    document.getElementById("revealOutput").textContent =
      err.message || "Reveal start failed";
  }
}

async function finalizeWinner() {
  try {
    const res = await adminFetch("/api/admin/finalize", { method: "POST" });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Finalize failed");

    document.getElementById("finalizeOutput").textContent =
      JSON.stringify(data, null, 2);

    await loadState();
  } catch (err) {
    document.getElementById("finalizeOutput").textContent =
      err.message || "Finalize failed";
  }
}

// On first load (optional): if secret already saved, show admin immediately
(function init() {
  const secret = getSecret();
  if (secret) {
    document.getElementById("loginStatus").textContent = "Authenticated";
    document.getElementById("adminContent").style.display = "block";
    loadState();
  } else {
    updateButtonsFromState();
  }
})();
</script>

</body>
</html>
